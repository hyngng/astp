name: Running

on:
  # 수동 실행 트리거 추가
  workflow_dispatch:
  
  schedule:
    # 미국 장 개장 시간 (ET 9:30 AM)
    - cron: '30 13 * * 1-5'  # UTC 13:30 (미국 서머타임-EDT 9:30, 한국 22:30)
    - cron: '30 14 * * 1-5'  # UTC 14:30 (미국 비서머타임-EST 9:30, 한국 23:30)
    
    # 1시간 간격으로 실행 (서머타임 - 미국 동부 시간 기준)
    - cron: '30 14 * * 1-5'  # UTC 14:30 (EDT 10:30, 한국 23:30)
    - cron: '30 15 * * 1-5'  # UTC 15:30 (EDT 11:30, 한국 00:30)
    - cron: '30 16 * * 1-5'  # UTC 16:30 (EDT 12:30, 한국 01:30)
    - cron: '30 17 * * 1-5'  # UTC 17:30 (EDT 13:30, 한국 02:30)
    - cron: '30 18 * * 1-5'  # UTC 18:30 (EDT 14:30, 한국 03:30)
    - cron: '30 19 * * 1-5'  # UTC 19:30 (EDT 15:30, 한국 04:30)
    
    # 1시간 간격으로 실행 (비서머타임 - 미국 동부 시간 기준)
    - cron: '30 15 * * 1-5'  # UTC 15:30 (EST 10:30, 한국 00:30)
    - cron: '30 16 * * 1-5'  # UTC 16:30 (EST 11:30, 한국 01:30)
    - cron: '30 17 * * 1-5'  # UTC 17:30 (EST 12:30, 한국 02:30)
    - cron: '30 18 * * 1-5'  # UTC 18:30 (EST 13:30, 한국 03:30)
    - cron: '30 19 * * 1-5'  # UTC 19:30 (EST 14:30, 한국 04:30)
    - cron: '30 20 * * 1-5'  # UTC 20:30 (EST 15:30, 한국 05:30)

jobs:
  auto-trading:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}
      ACCOUNT_NUMBER: ${{ secrets.ACCOUNT_NUMBER }}
      ACTUAL_APP_KEY: ${{ secrets.ACTUAL_APP_KEY }}
      ACTUAL_APP_SECRET: ${{ secrets.ACTUAL_APP_SECRET }}
      VIRTUAL_APP_KEY: ${{ secrets.VIRTUAL_APP_KEY }}
      VIRTUAL_APP_SECRET: ${{ secrets.VIRTUAL_APP_SECRET }}

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Update config.yaml
      run: |
        # data 폴더의 config.yaml 파일 경로
        config_file="data/config.yaml"
        
        # 파일 존재 확인
        if [ ! -f "$config_file" ]; then
          echo "data/config.yaml 파일을 찾을 수 없습니다."
          exit 1
        fi
        
        # 임시 파일 생성
        temp_file="data/temp_config.yaml"
        
        # config.yaml의 내용을 읽어서 필요한 부분만 수정
        awk -v account_id="$ACCOUNT_ID" \
            -v account_number="$ACCOUNT_NUMBER" \
            -v actual_app_key="$ACTUAL_APP_KEY" \
            -v actual_app_secret="$ACTUAL_APP_SECRET" \
            -v virtual_app_key="$VIRTUAL_APP_KEY" \
            -v virtual_app_secret="$VIRTUAL_APP_SECRET" \
            -v is_virtual="false" \
            '
            /^id:/ { print "id: " account_id; next }
            /^account:/ { print "account: " account_number; next }
            /^app_key:/ { print "app_key: " actual_app_key; next }
            /^app_secret:/ { print "app_secret: " actual_app_secret; next }
            /^virtual_app_key:/ { print "virtual_app_key: " virtual_app_key; next }
            /^virtual_app_secret:/ { print "virtual_app_secret: " virtual_app_secret; next }
            /^is_virtual:/ { print "is_virtual: " is_virtual; next }
            { print }
            ' "$config_file" > "$temp_file"
        
        # 임시 파일을 원본 파일로 이동
        mv "$temp_file" "$config_file"
        
        # 변경된 config.yaml 사용 준비 완료
        echo "data/config.yaml 파일 업데이트 완료"
        
    - name: Run ASTP
      run: |
        python main/main.py
      env:
        TZ: Asia/Seoul  # 한국 시간대 설정 